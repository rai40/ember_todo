<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Little ember app</title>
    <script src="/assets/jquery.js" type="text/javascript"></script>
    <script src="/assets/handlebars.js" type="text/javascript"></script>
    <script src="/assets/ember.js" type="text/javascript"></script>
    <script src="/assets/ember-data.js" type="text/javascript"></script>
  </head>
  <body>
    <script type="text/javascript">
      //
      // APP
      //
      App = Ember.Application.create();

      //
      // STORE
      //
      App.Store = DS.Store.extend({
        revision: 11,
        adapter: 'DS.FixtureAdapter'
      });

      //
      // ROUTER
      //
      App.Router.map(function() {
        this.route('about', {path: '/about'})
        this.route('why')
      });

      //
      // CLASSES
      //
      App.Person = DS.Model.extend({
        friends: DS.hasMany('App.Person'),

        firstName: DS.attr('string'),
        lastName: DS.attr('string'),

        fullName: function() {
          return [this.get("firstName"), this.get('lastName')].join(' ');
        }.property("firstName", "lastName")
      });

      App.Person.FIXTURES = [
        {
          id: "thorbjorn",
          firstName: "Thorbjørn",
          lastName: "Hermansen",
          friends: []
        },

        {
          id: "anders",
          firstName: "Anders",
          lastName: "Steinlein",
          friends: []
        }
      ];

      App.Person.reopenClass({
        splitFullName: function(fullName) {
          names = fullName.split(' ');

          return {
            firstName: names[0],
            lastName: names.slice(1).join(' ')
          };
        },

        createFromFullName: function(fullName) {
          return this.createRecord(this.splitFullName(fullName));
        }
      });


      //
      // CONTROLLERS
      //
      App.MeController = Ember.ObjectController.extend();

      App.FriendsController = Ember.ArrayController.extend({
        newFriendName: "",

        addFriend: function() {
          this.get('content').createRecord(App.Person.splitFullName(this.get('newFriendName')));
          this.set('newFriendName', '');
        },

        removeFriend: function removeFriend(friend) {
          this.get('content').removeObject(friend);
        }
      });


      //
      // ROUTES
      //
      App.ApplicationRoute = Ember.Route.extend({
        setupController: function() {
          thorbjorn = App.Person.find('thorbjorn');

          this.controllerFor('me').set('content', thorbjorn);
          this.controllerFor('friends').set('content', thorbjorn.get('friends'));
        }
      });
    </script>


    <script type="text/x-handlebars" id="application">
      <h1>Little Ember App</h1>
      {{partial "menu"}}
      {{outlet}}
    </script>

    <script type="text/x-handlebars" id="_menu">
      <ul>
        <li>{{#linkTo "index"}}Hjem{{/linkTo}}</li>
        <li>{{#linkTo "about"}}Om appen{{/linkTo}}</li>
        <li>{{#linkTo "why"}}Hvorfor?{{/linkTo}}</li>
      </ul>
    </script>


    <script type="text/x-handlebars" id="index">
      {{render "me"}}
      {{render "friends"}}
    </script>

    <script type="text/x-handlebars" id="about">
      Denne appen er laget av Thorbjørn.
    </script>

    <script type="text/x-handlebars" id="why">
      For å vise Ember.
    </script>


    <script type="text/x-handlebars" id="me">
      <h3>Mitt navn er: {{fullName}}<h3>
      <div>
        <label>
          Fornavn
          {{view Ember.TextField valueBinding="firstName"}}
        </label>
      </div>

      <div>
        <label>
          Fornavn
          {{view Ember.TextField valueBinding="lastName"}}
        </label>
      </div>
    </script>

    <script type="text/x-handlebars" id="friends">
      <h4>Jeg har {{length}} venner..</h4>

      <div>
        <label>Legg til venn..</label>
        {{view Ember.TextField valueBinding="newFriendName" action="addFriend"}}
        <button {{action addFriend}}>Legg til</button>
      </div>

      {{#each friend in controller}}
        <div>
          <button {{action removeFriend friend}}>X</button>
          {{friend.fullName}}
        <div>
      {{else}}
      <p>Du kan legge til en venn!</p>
      {{/each}}
    </script>

  </body>
</html>
